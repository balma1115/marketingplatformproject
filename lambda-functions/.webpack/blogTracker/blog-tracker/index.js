(()=>{var e={351:e=>{"use strict";e.exports=require("playwright-aws-lambda")},446:e=>{"use strict";e.exports=require(".prisma/client/default")},610:(e,o,a)=>{e.exports={...a(446)}}},o={};function a(r){var t=o[r];if(void 0!==t)return t.exports;var n=o[r]={exports:{}};return e[r](n,n.exports,a),n.exports}var r={};(()=>{"use strict";var e=r;Object.defineProperty(e,"__esModule",{value:!0}),e.handler=void 0;const o=a(610),t=a(351),n=new o.PrismaClient;function l(){const e=new Date,o=e.getTime()+6e4*e.getTimezoneOffset();return new Date(o+324e5)}async function s(e,o,a){const r=function(e){const o=[/blog\.naver\.com\/([^/?]+)/,/blog\.naver\.com\/PostView\.naver\?blogId=([^&]+)/,/m\.blog\.naver\.com\/([^/?]+)/,/blog\.naver\.com\/.*blogId=([^&]+)/];for(const a of o){const o=e.match(a);if(o)return o[1]}try{const o=new URL(e).pathname.split("/").filter(e=>e);if(o.length>0&&"PostView.naver"!==o[0])return o[0]}catch(e){console.error("Failed to parse blog URL:",e)}return null}(o);if(!r)throw console.error("Invalid blog URL:",o),new Error("Invalid blog URL");console.log(`Checking ranking for blog ${r} with keyword: ${a}`);let t={mainTabExposed:!1,mainTabRank:null,blogTabRank:null,viewTabRank:null,adRank:null,found:!1,url:null};try{const o=`https://search.naver.com/search.naver?query=${encodeURIComponent(a)}`;await e.goto(o,{waitUntil:"domcontentloaded"}),await e.waitForTimeout(2e3);const n=await e.evaluate(e=>{const o=[".link_ad",".ad_label",'[class*="_ad"]','[class*="splink_ad"]',".power_link",".brand_search"],a=document.querySelectorAll('a[href*="blog.naver.com"]');let r=!1,t="";return a.forEach(a=>{const n=a.href||"";let l=!1;const s=a.closest("li, article, section");if(s)for(const e of o)if(s.querySelector(e)||s.matches(e)){l=!0;break}!l&&(n.includes(`/${e}/`)||n.includes(`/${e}?`)||n.includes(`blogId=${e}`))&&(r=!0,t||(t=n))}),{exposed:r,firstUrl:t}},r);console.log(`Main tab (노출 여부) for ${r}:`,n.exposed),n.exposed&&(t.mainTabExposed=!0,t.found=!0,t.url=n.firstUrl);const l=`https://search.naver.com/search.naver?ssc=tab.blog.all&sm=tab_jum&query=${encodeURIComponent(a)}`;await e.goto(l,{waitUntil:"domcontentloaded"}),await e.waitForTimeout(3e3);const s=await e.evaluate(e=>{let o=0,a=null,r=null,t=0;return document.querySelectorAll("#main_pack > section").forEach(n=>{n.querySelectorAll("div.api_subject_bx").forEach(n=>{n.querySelectorAll("ul > li").forEach(n=>{if(t++,null===n.querySelector(".link_ad")&&!n.classList.contains("sp_nreview_ad")){o++;let t="";const l=n.querySelector(".sub_txt.sub_name, .user_info > a, .user_box_inner a.name");if(l&&l.href){const e=l.href.match(/blog\.naver\.com\/([^/?]+)/);e&&(t=e[1])}if(!t){const e=n.querySelector(".api_txt_lines.total_tit, .total_tit");if(e&&e.href){const o=e.href.match(/blog\.naver\.com\/([^/?]+)/);o&&(t=o[1])}}if(t===e&&!a){a=o;const e=n.querySelector('a[href*="blog.naver.com"]');e&&(r=e.href)}}})})}),document.querySelectorAll("li.bx").forEach(n=>{if(n.closest("div.api_subject_bx"))return;t++;const l=n.className;if(!l.includes("sp_nreview_ad")&&!l.includes("splink")&&null===n.querySelector(".link_ad")){o++;let t="";const l=n.querySelector(".sub_txt.sub_name, .user_info > a, .user_box_inner a.name");if(l&&l.href){const e=l.href.match(/blog\.naver\.com\/([^/?]+)/);e&&(t=e[1])}if(!t){const e=n.querySelector('a[href*="blog.naver.com"]');if(e&&e.href){const o=e.href.match(/blog\.naver\.com\/([^/?]+)/);o&&(t=o[1])}}if(t===e&&!a){a=o;const e=n.querySelector('a[href*="blog.naver.com"]');e&&(r=e.href)}}}),{rank:a,url:r,totalItems:t,realItemCount:o}},r);console.log(`Blog tab results for ${r}:`,{rank:s.rank,totalItems:s.totalItems}),s.rank&&(t.blogTabRank=s.rank,t.found=!0,t.url=t.url||s.url)}catch(e){throw console.error("Error extracting blog rankings:",e),e}return t}e.handler=async(e,o)=>{const a=Date.now(),r=[];for(const o of e.Records){let e=null;const c=JSON.parse(o.body);console.log(`Processing blog keyword: ${c.keyword} (ID: ${c.keywordId})`);try{e=await t.launchChromium();const o=await e.newContext(),i=await o.newPage(),u=await s(i,c.blogUrl,c.keyword),d=l();await n.blogTrackingResult.create({data:{keywordId:c.keywordId,trackingDate:d,mainTabExposed:u.mainTabExposed,mainTabRank:u.mainTabRank,blogTabRank:u.blogTabRank,viewTabRank:u.viewTabRank,adRank:u.adRank}}),await n.blogTrackingKeyword.update({where:{id:c.keywordId},data:{}});const b=(Date.now()-a)/1e3;r.push({keywordId:c.keywordId,success:!0,mainTabRank:u.mainTabRank,blogTabRank:u.blogTabRank,viewTabRank:u.viewTabRank,duration:b}),console.log(`Successfully tracked blog keyword ${c.keyword}:`,{mainTab:u.mainTabRank,blogTab:u.blogTabRank,viewTab:u.viewTabRank})}catch(e){throw console.error(`Error tracking blog keyword ${c.keyword}:`,e),r.push({keywordId:c.keywordId,success:!1,error:e.message}),e}finally{e&&await e.close()}}return{statusCode:200,body:JSON.stringify({message:"Blog tracking completed",results:r,totalDuration:(Date.now()-a)/1e3})}}})(),module.exports=r})();